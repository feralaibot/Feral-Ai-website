<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>FANG Generator</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self';">
    <link rel="stylesheet" href="./style.css">
    <style>
      :root {
        --bg: #050608;
        --accent: #52ff9a;
        --border: rgba(82, 255, 154, 0.25);
        --card: #0b0f14;
        --text: #e8f3ec;
        --muted: #a7b3b0;
      }

      #gate {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        background: rgba(5, 6, 8, 0.94);
        z-index: 9999;
        padding: 16px;
      }

      #gate-panel {
        width: min(520px, 100%);
        padding: 24px;
        border-radius: 16px;
        border: 1px solid rgba(255, 77, 77, 0.35);
        background: rgba(10, 10, 12, 0.92);
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
        color: var(--text);
        font-family: "Space Grotesk", "IBM Plex Mono", system-ui, sans-serif;
      }

      .gate-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .gate-lock {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        background: rgba(255, 77, 77, 0.12);
        border: 1px solid rgba(255, 77, 77, 0.3);
      }

      .gate-title {
        font-size: 18px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin: 0;
      }

      #gate-panel p { margin: 0 0 16px; color: var(--muted); }

      .gate-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .gate-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 18px;
        border-radius: 10px;
        border: 1px solid rgba(255, 77, 77, 0.5);
        background: rgba(255, 77, 77, 0.15);
        color: #ff4d4d;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .gate-btn.secondary {
        border-color: rgba(255, 255, 255, 0.18);
        color: var(--text);
        background: rgba(255, 255, 255, 0.04);
      }

      .gate-btn:hover { box-shadow: 0 0 0 6px rgba(255, 77, 77, 0.12); transform: translateY(-1px); }

      #gate-status { margin-top: 12px; color: #ff4d4d; font-size: 13px; min-height: 18px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  </head>
  <body>
    <div id="gate">
      <div id="gate-panel">
        <div class="gate-header">
          <div class="gate-lock" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#ff4d4d" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <rect x="5" y="10" width="14" height="10" rx="2"></rect>
              <path d="M8 10V7a4 4 0 0 1 8 0v3"></path>
            </svg>
          </div>
          <h3 class="gate-title">Holder Access Only</h3>
        </div>
        <p id="gate-msg">Connect and verify your wallet to unlock the generator.</p>
        <div class="gate-actions">
          <button class="gate-btn" id="gate-verify">Connect Wallet</button>
          <a class="gate-btn secondary" href="/" rel="noopener">Open portal</a>
        </div>
        <div id="gate-status"></div>
      </div>
    </div>

    <div class="app-shell">
      <header class="hero">
        <div>
          <div class="hero-kicker">Generative art toolkit</div>
          <div class="header">FANG Generator</div>
          <p class="small hero-subtitle">Pick input &amp; output folders, set options, define rules, then Generate.</p>
        </div>
        <div class="hero-meta">
          <span class="pill">Now with quick trait uploads</span>
        </div>
      </header>

      <section class="panel glass">
        <div class="controls">
          <button id="btnLayers">Select Input Folder…</button>
          <span class="path" id="layersPath"></span>

          <button id="btnOut" disabled>Outputs as ZIP download</button>
          <span class="path" id="outPath">No folder needed; downloads to your browser.</span>
        </div>

        <div class="controls stackable">
          <div class="field">Canvas:
            <input id="w" type="number" value="1024"> ×
            <input id="h" type="number" value="1024">
          </div>
          <div class="field">Supply: <input id="supply" type="number" value="100"></div>
          <div class="field">Name: <input id="namePrefix" type="text" value="FANG"></div>
          <div class="field">Symbol: <input id="symbol" type="text" value="FANG"></div>
          <div class="field">Creator Wallet: <input id="wallet" type="text" value="YOUR_WALLET"></div>
        </div>
      </section>

      <section class="panel glass preview-panel">
        <div class="section-head">
          <h3>Live Preview</h3>
          <div class="actions">
            <button id="previewRandomize">Randomize Preview</button>
          </div>
        </div>
        <div class="preview-shell">
          <canvas id="previewCanvas" width="1024" height="1024"></canvas>
          <div class="preview-meta">
            <div class="small">Preview updates as you change weights and rules.</div>
            <div class="small" id="previewStatus">Load layers to start.</div>
          </div>
        </div>
      </section>

      <section class="panel glass">
        <div class="section-head">
          <h3>Layers <span class="small">(top → bottom)</span></h3>
          <div class="actions">
            <button id="expandAll">Expand all</button>
            <button id="collapseAll">Collapse all</button>
          </div>
        </div>

        <!-- Scrollable panel for many layers -->
        <div id="layersScroll" class="scroll-panel">
          <div id="layersContainer"></div>
        </div>
      </section>

      <section class="panel glass">
        <div class="section-head">
          <h3>Rules</h3>
          <div class="actions">
            <button id="addBlock">+ Add Block</button>
            <button id="addForce">+ Add Force</button>
          </div>
        </div>
        <div id="rulesScroll" class="scroll-panel small-pad">
          <div class="card">
            <div class="rule-head">
              <strong>Block rules</strong> <span class="small">A cannot appear with B</span>
            </div>
            <div id="blockRules" class="rules-grid"></div>
          </div>

          <div class="card">
            <div class="rule-head">
              <strong>Force rules</strong> <span class="small">If A, then require B (use “None” to hide)</span>
            </div>
            <div id="forceRules" class="rules-grid"></div>
          </div>
        </div>
      </section>

      <section class="panel glass action-bar">
        <button id="btnGenerate" class="primary">Generate</button>
        <div class="status" id="status">Ready.</div>
      </section>
    </div>

    <script type="module">
      import bs58 from "https://cdn.jsdelivr.net/npm/bs58@5.0.0/+esm";

      const VERIFY_CACHE_KEY = "feral_wallet_verification";
      const VERIFY_CACHE_TTL_MS = 5 * 60 * 1000;

      const gate = document.getElementById("gate");
      const verifyBtn = document.getElementById("gate-verify");
      const msg = document.getElementById("gate-msg");
      const status = document.getElementById("gate-status");

      function readVerificationCache(publicKey) {
        try {
          const raw = sessionStorage.getItem(VERIFY_CACHE_KEY);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (
            parsed?.publicKey === publicKey &&
            typeof parsed.timestamp === "number" &&
            Date.now() - parsed.timestamp < VERIFY_CACHE_TTL_MS
          ) {
            return parsed;
          }
        } catch {
          return null;
        }
        return null;
      }

      function writeVerificationCache(payload) {
        try {
          sessionStorage.setItem(VERIFY_CACHE_KEY, JSON.stringify(payload));
        } catch {
          // Ignore storage failures.
        }
      }

      function getProvider() {
        const provider = window.solana;
        if (!provider || !provider.isPhantom) return null;
        return provider;
      }

      function unlockGate() {
        gate.remove();
      }

      async function verifyWallet() {
        const provider = getProvider();
        if (!provider) {
          msg.textContent = "Phantom wallet not detected. Install Phantom or use the portal.";
          status.textContent = "";
          return;
        }

        status.textContent = "Connecting wallet...";
        msg.textContent = "Signature required to verify holdings.";

        try {
          const connectResult = await provider.connect();
          const publicKey =
            connectResult?.publicKey?.toBase58?.() ||
            provider.publicKey?.toBase58?.() ||
            provider.publicKey?.toString();

          if (!publicKey) {
            throw new Error("Wallet address not available.");
          }

          const cached = readVerificationCache(publicKey);
          if (cached?.isEligible) {
            unlockGate();
            return;
          }

          const nonce = crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2);
          const message = [
            "FERAL Wallet Verification",
            `Address: ${publicKey}`,
            `Nonce: ${nonce}`,
            `Issued At: ${new Date().toISOString()}`,
          ].join("\n");

          const encoded = new TextEncoder().encode(message);
          const signed = await provider.signMessage(encoded, "utf8");
          const signature = signed?.signature ? signed.signature : signed;

          status.textContent = "Verifying...";

          const res = await fetch("/api/wallet/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              publicKey,
              message,
              signature: bs58.encode(signature),
            }),
          });

          if (!res.ok) {
            const error = await res.json().catch(() => ({}));
            throw new Error(error.message || "Verification failed.");
          }

          const payload = await res.json();
          writeVerificationCache({
            publicKey,
            timestamp: Date.now(),
            holdings: payload.holdings,
            accessTier: payload.accessTier,
            isEligible: payload.isEligible,
          });

          if (payload.isEligible) {
            unlockGate();
            return;
          }

          status.textContent = "";
          msg.textContent = "Holdings not detected for required access.";
        } catch (error) {
          status.textContent = "";
          msg.textContent =
            error instanceof Error ? error.message : "Verification failed. Please retry.";
        }
      }

      (async () => {
        const provider = getProvider();
        const publicKey = provider?.publicKey?.toBase58?.() || provider?.publicKey?.toString();
        if (publicKey) {
          const cached = readVerificationCache(publicKey);
          if (cached?.isEligible) {
            unlockGate();
            return;
          }
        }

        verifyBtn.addEventListener("click", verifyWallet);
      })();
    </script>
    <script type="module" src="./renderer.js"></script>
  </body>
</html>
